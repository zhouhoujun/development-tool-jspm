"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),_get=function e(n,t,r){null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,t);if(void 0===s){var o=Object.getPrototypeOf(n);return null===o?void 0:e(o,t,r)}if("value"in s)return s.value;var i=s.get;if(void 0!==i)return i.call(r)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},__decorate=function(e,n,t,r){var s,o=arguments.length,i=o<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,t):r;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,n,t,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(n,t,i):s(n,t))||i);return o>3&&i&&Object.defineProperty(n,t,i),i},__metadata=function(e,n){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)},_=require("lodash"),development_core_1=require("development-core"),path=require("path"),fs_1=require("fs"),chalk=require("chalk"),replace=require("gulp-replace"),jspm=require("jspm"),source=require("vinyl-source-stream"),vinylBuffer=require("vinyl-buffer"),chksum=require("checksum"),mkdirp=require("mkdirp"),JspmBundle=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.name="jspm-bundle",t.runWay=development_core_1.RunWay.sequence,t.manifestSplit="/*------bundles infos------*/",t}return _inherits(n,e),_createClass(n,[{key:"getOption",value:function(e){return e.option}},{key:"loadBuilder",value:function(e){var n=e.option;jspm.setPackagePath(path.dirname(e.toStr(n.packageFile)));var t=new jspm.Builder({separateCSS:n.builder.separateCSS});return Promise.resolve(t).then(function(e){return n.jspmConfig?_.isArray(n.jspmConfig)?Promise.all(n.jspmConfig.map(function(n){return e.loadConfig(n,void 0,!0)})).then(function(){return e}):e.loadConfig(n.jspmConfig,void 0,!0).then(function(){return e}):e})}},{key:"translate",value:function(e){return _.isArray(e)?_.map(e,function(e){return e.stream.bundle=e.bundle,e.stream}):(e.stream.bundle=e.bundle,e.stream)}},{key:"initBundles",value:function(e){var n=this,t=e.option,r=Promise.resolve(null).then(function(){return e.to(t.bundles)});return t.bundleDeps&&(r=r.then(function(n){var r=e.getPackage(t.packageFile);r||(console.log(chalk.red("can not found package.json file.")),process.exit(0));var s=t.dependencies?e.to(t.dependencies):_.keys(r.jspm.dependencies);return(!s||s.length<0)&&(console.log(chalk.red("not set bundle dependencies libs, or not setting jspm config.")),process.exit(0)),t.depsExclude&&!function(){var n=_.isFunction(t.depsExclude)?t.depsExclude(e,s):t.depsExclude;s=_.filter(s,function(e){return n.indexOf(e)<0})}(),Promise.resolve().then(function(){return _.isFunction(t.bundleDeps)?t.bundleDeps(e,s):_.isBoolean(t.bundleDeps)?{deplibs:{combine:!0,items:s}}:t.bundleDeps}).then(function(e){var t=_.keys(e);return _.each(_.keys(n),function(r){var s=n[r];s.exclude=s.exclude||[],s.exclude=t.concat(s.exclude),e[r]=s}),e})})),r.then(function(e){return n.bundleConfig=e,console.log("group bundles setting:\n",e,"---------------------------------\n"),e})}},{key:"source",value:function(e,n,t){var r=this,s=e.option;return s.bundles?this.initBundles(e).then(function(){return Promise.all(_.map(r.getBundles(e),function(n){return r.loadBuilder(e).then(function(s){var o=r.bundleConfig[n],i=r.getBuildConfig(e);return o.builder=_.defaults(o.builder,i),o.builder.config&&s.config(o.builder.config),r.groupBundle(e,s,n,o,t).then(function(e){return r.translate(e)})})}))}).then(function(e){return _.flatten(e)}):this.loadBuilder(e).then(function(n){var t=e.getSrc(r.getInfo());console.log("start bundle all src : ",chalk.cyan(t));var s=r.getBuildConfig(e);return s.config&&n.config(s.config),e.fileFilter(t).then(function(t){t=r.getRelativeSrc(e,t),console.log("bundle files:",chalk.cyan(t));var o=r.getBundleManifestPath(e);return r.createBundler(e,n,"bundle",t.join(" + "),o,s).then(function(e){return r.translate(e)})})})}},{key:"getRelativeSrc",value:function(e,n){var t=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=e.option.bundleBaseDir;if(_.isArray(n))return _.map(n,function(n){var o=e.toUrl(s,n);return r?t.toModulePath(o):o});var o=e.toUrl(s,n);return[r?this.toModulePath(o):o]}},{key:"toModulePath",value:function(e){return e?e.substring(0,e.length-path.extname(e).length):""}},{key:"initOption",value:function(e){var n=_.extend({baseURL:"",bundleBaseDir:".",mainfile:"bundle.js",jspmConfig:"",packageFile:"package.json",dest:"",file:"",systemConfigTempl:"",relationToRoot:"",bust:"",bundles:null,bundlePaths:function(e){var t={},r=e.getDist(),s=n.bundleBaseDir;return e.getFolders(s,function(n,o){if(n!==r){var i=o+"/*";t[i]=e.toUrl(e.env.root,path.join(s,i))}return""}),console.log("paths: ",t),t},includePackageFiles:["system-polyfills.src.js","system.src.js"],jspmMates:{"*.css":{loader:"css"},"*.json":{loader:"json"},"*.jsx":{loader:"jsx"}},builder:{sfx:!1,minify:!1,mangle:!1,sourceMaps:!1,separateCSS:!1,lowResSourceMaps:!0}},e.option);e.option=n,n.baseURL=e.toRootPath(e.toStr(n.baseURL)),!n.bundleBaseDir&&e.parent?n.bundleBaseDir=e.parent.getDist():n.bundleBaseDir?n.bundleBaseDir=e.toRootPath(e.toStr(n.bundleBaseDir)):(console.log(chalk.red("bundleBaseURL config error!")),process.exit(0)),n.jspmConfig&&(n.jspmConfig=e.toRootSrc(e.toSrc(n.jspmConfig))),n.packageFile=e.toRootPath(e.toStr(n.packageFile)),n.mainfile=e.toStr(n.mainfile);var t=e.getPackage(n.packageFile);return n.jspmPackages||(t.jspm.directories&&t.jspm.directories.packages?n.jspmPackages=t.jspm.directories.packages:n.jspmPackages="jspm_packages"),n.jspmPackages=e.toRootPath(e.toStr(n.jspmPackages)),fs_1.readdirSync(n.jspmPackages)||(console.log(chalk.red("jspm project config error!")),process.exit(0)),n}},{key:"getBuildConfig",value:function(e){var n=e.option;return n.builder.config||(n.builder.config=_.extend(n.builder.config||{},{paths:e.to(n.bundlePaths)||{},rootURL:n.bundleBaseDir})),n.builder}},{key:"execute",value:function(e,t){var r=this;this.bundleMaps=[];var s=e;return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"execute",this).call(this,s,t).then(function(){var e=s.option;return e.bundles?r.calcChecksums(e,r.bundleMaps).then(function(e){return r.updateBundleManifest(s,r.bundleMaps,e)}):null}).then(function(e){return e?r.writeBundleManifest(s,e,t).then(function(){console.log(chalk.green("------ Complete -------------"))}):(console.log(chalk.green("------ Complete -------------")),null)})}},{key:"setup",value:function(e,t){return e.option=this.initOption(e),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setup",this).call(this,e,t)}},{key:"getAssertResetPipe",value:function(e){var n=this;if(!this.restps){var t=e.option;_.isUndefined(t.resetAsserts)&&(t.resetAsserts="assets"),t.resetAsserts?!function(){var r=void 0;if(_.isString(t.resetAsserts)){var s=e.toDistPath(t.resetAsserts,n.getInfo());fs_1.existsSync(s)?(r=e.getFolders(s),r.push(s)):console.log(chalk.yellow("rest css asserts folders:",s,"not exists."))}else r=e.toDistSrc(t.resetAsserts,n.getInfo());r=r||[];var o=[],i=e.getDist(n.getInfo()),a=t.baseURL,l=e.getRootPath();_.each(r,function(n){var t=e.toUrl(l,path.join(a,e.toUrl(i,n))),r=path.basename(n);console.log("reset css url folder name:",chalk.cyan(r),"relate url:",chalk.cyan(t));var s=new RegExp("(url\\((\\.\\.\\/)+"+r+")|(url\\(\\/"+r+")","gi");o.push(function(){return replace(s,"url("+t)});var u=new RegExp("(url\\(\\\\'(\\.\\.\\/)+"+r+")|(url\\(\\\\'\\/"+r+")","gi");o.push(function(){return replace(u,"url(\\'"+t)})}),n.restps=o}():this.restps=[]}return this.restps}},{key:"pipes",value:function e(t,r,s){var e=_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"pipes",this).call(this,t,r,s)||[],o=this.getAssertResetPipe(t);return o&&o.length>0&&(e=e.concat(o)),e}},{key:"working",value:function(e,t,r,s,o,i){var a=this,l=e.bundle;return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"working",this).call(this,e,t,r,s,o,i).then(function(){var e={path:l.path,modules:l.modules};a.bundleMaps.push(e),l.sfx?console.log("Built sfx package: "+chalk.cyan(l.bundleName)+" -> "+chalk.cyan(l.filename)+"\n   dest: "+chalk.cyan(l.bundleDest)):console.log("Bundled package: "+chalk.cyan(l.bundleName)+" -> "+chalk.cyan(l.filename)+"\n   dest: "+chalk.cyan(l.bundleDest))})}},{key:"getBundles",value:function(e){var n=this,t=[];return e.env.gb&&(t=_.uniq(_.isArray(e.env.gb)?e.env.gb:(e.env.gb||"").split(","))),t=t.length<1?_.keys(this.bundleConfig):_.filter(t,function(e){return e&&n.bundleConfig[e]}),console.log("cmmand group bundle:",chalk.cyan(t)),t}},{key:"groupBundle",value:function(e,n,t,r,s){var o=this,i="",a="",l=[],u=this.exclusionString(r.exclude,this.bundleConfig);return r.items&&(l=_.isArray(l)?r.items:_.keys(r.items)),r.combine?(a=this.getBundleDest(e,t,r),i=l.join(" + ")+u,console.log("Bundling group: "+chalk.cyan(t)+" ... \ngroup source:\n  "+chalk.cyan(i)+"\n-------------------------------"),this.createBundler(e,n,t,i,a,r.builder,r)):(console.log("Bundling group: "+chalk.cyan(t)+" ... \ngroup items:\n  "+chalk.cyan(l)+"\n-------------------------------"),Promise.all(l.map(function(t){return i=t+u,a=o.getBundleDest(e,t,r),o.createBundler(e,n,t,i,a,r.builder,r)})))}},{key:"exclusionString",value:function(e,n){var t=this.exclusionArray(e,n).join(" - ");return t?" - "+t:""}},{key:"exclusionArray",value:function(e,n){var t=this,r=[];return e=_.isArray(e)?e:_.keys(e),_.forEach(e,function(e){var s=n[e];s?r=r.concat(t.exclusionArray(s.items,n)):r.push(e)}),r}},{key:"createBundler",value:function(e,n,t,r,s,o,i){var a=o.sfx,l=a?n.buildStatic:n.bundle,u=this.getBundleShortPath(e,t,i),c=path.parse(s).base;return l.bind(n)(r,s,o).then(function(e){mkdirp.sync(path.dirname(s));var n=source(c);return n.write(e.source),process.nextTick(function(){n.end()}),console.log("pipe bundling：",chalk.cyan(t)),{stream:n.pipe(vinylBuffer()),bundle:{path:u,sfx:a,bundleName:t,filename:c,bundleDest:s,modules:e.modules}}})}},{key:"calcChecksums",value:function(e,n){var t={};return console.log("Calculating checksums..."),Promise.all(_.map(n,function(n){return _.isObject(n)?new Promise(function(r,s){var o=path.join(e.bundleBaseDir||".",n.path),i=path.parse(n.path).base;chksum.file(o,function(e,s){e&&console.error(chalk.red(" Checksum Error:"),chalk.red(e)),console.log(i,chalk.cyan(s)),t[n.path]=s,r(t)})}):null})).then(function(){return t})}},{key:"updateBundleManifest",value:function(e,n,t){t=t||{};var r=_.defaults(this.getBundleManifest(e),{bundles:{},chksums:{}});return _.each(n,function(e){e.path&&(r.bundles[e.path]=e.modules,r.chksums[e.path]=t[e.path]||"")}),r}},{key:"writeBundleManifest",value:function(e,t,r){var s=this,o=e.option;if(!o.mainfile)return Promise.reject("mainfile not configed.");console.log("Writing manifest...");var i=e.toUrl(e.getRootPath(),o.baseURL)||".";console.log("system config baseURL: ",chalk.cyan(i));var a=e.toStr(o.bust);console.log("system bust: ",chalk.cyan(a));var l="\nSystem.config({\n    baseURL: '"+i+"',\n    defaultJSExtensions: true\n});\nSystem.bundled = true;\nSystem.bust = '"+a+"';\nif(window != undefined) window.prod = true;\n"+this.manifestSplit+"\n",u="";t&&!function(){u=e.toStr(o.systemConfigTempl),u||(u=a?"\n(function(module) {\n    var bust = {};\n    var systemLocate = System.locate;\n    var systemNormalize = System.normalize;\n    var paths =  module.exports.paths = ${paths} || {};\n    var chksums = module.exports.chksums = ${chksums};\n    var bundles = module.exports.bundles = ${bundles};                    \n    var maps = ${ maps };\n    var jspmMeta = ${ jspmMeta };\n\n    System.config({\n            packages: {\n            \"meta\": jspmMeta\n        },\n        map: maps,\n        paths: paths,\n        bundles: bundles\n    });\n\n    System.normalize = function (name, pName, pAddress) {\n        return systemNormalize.call(this, name, pName, pAddress).then(function (address) {\n            var chksum = chksums[name];\n            if (chksums[name]) { bust[address] = chksum; }\n            return address;\n        });\n    };\n\n    System.locate = function (load) {\n        return Promise.resolve(systemLocate.call(this, load)).then(function (address) {\n            var chksum = bust[address];\n            return (chksum) ? address + '?' + chksum : address;\n        });\n    };\n\n})((typeof module !== 'undefined') ? module : {exports: {}}, this);\n":"\n(function(module) {\n    var bundles = module.exports.bundles = ${bundles};\n    var paths =  module.exports.paths = ${paths} || {};\n    var maps = ${ maps };\n    var jspmMeta = ${ jspmMeta };\n\n    System.config({\n            packages: {\n            \"meta\": jspmMeta\n        },\n        map: maps,\n        paths: paths,\n        bundles: bundles\n    });\n\n})((typeof module !== 'undefined') ? module : {exports: {}}, this);\n");var n={css:"github:systemjs/plugin-css@0.1.20.js",json:"github:systemjs/plugin-json@0.1.2.js"};_.each(_.keys(t.bundles),function(e){/css.min.js$/.test(e)&&(n.css=_.first(t.bundles[e])),/json.min.js$/.test(e)&&(n.css=_.first(t.bundles[e]))});var r=o.jspmMates;l+=_.template(u)({maps:JSON.stringify(n,null,"    "),jspmMeta:JSON.stringify(r,null,"    "),paths:JSON.stringify(o.builder.config?o.builder.config.paths:null,null,"    "),chksums:JSON.stringify(t.chksums,null,"    "),bundles:JSON.stringify(t.bundles,null,"    ")})}();var c=o.includes||[];return c=c.concat(_.map(o.includePackageFiles,function(e){return path.join(o.jspmPackages,e)})),Promise.all(_.map(c,function(e){return new Promise(function(n,t){fs_1.readFile(e,"utf8",function(e,r){e?t(e):n(r)})})})).then(function(t){t.push(l);var i=e.toStr(o.mainfile);console.log("mainfile:",i),mkdirp.sync(path.dirname(i));var a=source(i);return a.write(t.join("\n")),process.nextTick(function(){a.end()}),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"working",s).call(s,a.pipe(vinylBuffer()),e,o,r,o.mainfilePipes||[],o.mainfileOutput)})}},{key:"getBundleManifestPath",value:function(e){return this.getBundleDest(e,e.option.mainfile)}},{key:"getBundleManifest",value:function(e){var n={},t=this.getBundleManifestPath(e);if(console.log("try to load old bundle in path ",t),fs_1.existsSync(t))try{var r=fs_1.readFileSync(t,"utf8"),s=r.indexOf(this.manifestSplit);s=s>0?s+this.manifestSplit.length:0,r=r.substring(s),fs_1.writeFileSync(t,r),n=require(t),console.log("has old bundle：\n",chalk.cyan(t))}catch(e){console.log(chalk.red(e))}else console.log("no old bundle：\n",chalk.cyan(t));return n}},{key:"getBundleShortPath",value:function(e,n,t){var r=t?this.getBundleDest(e,n,t):path.join(e.getDist(),n);return e.toUrl(e.option.bundleBaseDir,r)}},{key:"getBundleDest",value:function(e,n,t){var r=e.getDist();if(t){var s=t.builder.minify,o=t.items[n]||n,i=o+(s?".min.js":".js");r=t.combine?path.join(r,i):path.join(r,n,i)}else r=path.join(r,n);return r}}]),n}(development_core_1.PipeTask);JspmBundle=__decorate([development_core_1.task({oper:development_core_1.Operation.release|development_core_1.Operation.deploy}),__metadata("design:paramtypes",[Object])],JspmBundle),exports.JspmBundle=JspmBundle;
//# sourceMappingURL=sourcemaps/JspmBundle.js.map

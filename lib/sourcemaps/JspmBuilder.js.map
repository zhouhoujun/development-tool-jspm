{"version":3,"sources":["JspmBuilder.ts"],"names":[],"mappings":"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","file":"../JspmBuilder.js","sourcesContent":["// import * as _ from 'lodash';\r\n// import * as path from 'path';\r\n// import * as gulp from 'gulp';\r\n// import { readFileSync, existsSync, writeFileSync } from 'fs';\r\n// import * as chalk from 'chalk';\r\n// // const babel = require('gulp-babel');\r\n// const jspm = require('jspm');\r\n// const source = require('vinyl-source-stream');\r\n// const vinylBuffer = require('vinyl-buffer');\r\n// // const ngAnnotate = require('gulp-ng-annotate');\r\n// // const sourcemaps = require('gulp-sourcemaps');\r\n// const uglify = require('gulp-uglify');\r\n// const chksum = require('checksum');\r\n// const mkdirp = require('mkdirp');\r\n\r\n// import { bindingConfig } from 'development-core';\r\n// import { IJspmTaskConfig, IBundlesConfig, IBuidlerConfig, IBundleGroup, IBuilder } from './config';\r\n\r\n// /**\r\n//  * jspm builder.\r\n//  * \r\n//  * @export\r\n//  * @class JspmBuilder\r\n//  */\r\n// export class JspmBuilder implements IBuilder {\r\n//     constructor(private config: IJspmTaskConfig) {\r\n//         this.init();\r\n//     }\r\n\r\n//     private init() {\r\n\r\n//         if (!this.config.getDist) {\r\n//             this.config = <IJspmTaskConfig>bindingConfig(this.config);\r\n//         }\r\n//         let option = _.extend(<IBundlesConfig>{\r\n//             baseURL: '',\r\n//             jspmConfig: 'jspm.conf.js',\r\n//             dest: '',\r\n//             file: '',\r\n//             systemConfigTempl: '',\r\n//             relationToRoot: '',\r\n//             bust: '',\r\n//             bundles: {},\r\n//             jspmMates: {\r\n//                 '*.css': {\r\n//                     loader: 'css'\r\n//                 },\r\n//                 '*.json': {\r\n//                     loader: 'json'\r\n//                 },\r\n//                 '*.jsx': {\r\n//                     loader: 'jsx'\r\n//                 }\r\n//             },\r\n//             builder: {\r\n//                 sfx: false,\r\n//                 minify: false,\r\n//                 mangle: false,\r\n//                 sourceMaps: false,\r\n//                 separateCSS: false,\r\n//                 lowResSourceMaps: true\r\n//             }\r\n//         }, this.config.option);\r\n\r\n//         // console.log(this.options.bundles);\r\n//         this.config.env.root = this.config.env.root || (path.dirname(module.parent.filename) + '/');\r\n\r\n//         if (!path.isAbsolute(option.baseURL)) {\r\n//             option.baseURL = path.join(this.config.env.root, option.baseURL, '/');\r\n//         }\r\n\r\n//         if (!path.isAbsolute(option.jspmConfig)) {\r\n//             option.jspmConfig = path.join(this.config.env.root, option.jspmConfig);\r\n//         }\r\n\r\n//         if (_.isFunction(option.bundles)) {\r\n//             option.bundles = option.bundles(this.config);\r\n//         }\r\n\r\n//         this.config.option = option;\r\n//         console.log('bundles config:', chalk.cyan(<any>this.config));\r\n//     }\r\n\r\n//     bundleAll(name: string, src: string | string[], dest: string, bundlesConfig?: IBundlesConfig): Promise<any> {\r\n//         bundlesConfig = bundlesConfig || this.config.option;\r\n\r\n//         let builder = new jspm.Builder({ separateCSS: bundlesConfig.builder.separateCSS });\r\n\r\n//         builder.config(bundlesConfig.builder.config);\r\n\r\n//         let sfx = bundlesConfig.builder.sfx;\r\n//         var bundler = (sfx) ? builder.buildStatic : builder.bundle;\r\n\r\n//         return new Promise<any>((resolve, reject) => {\r\n//             bundler.bind(builder)(src, bundlesConfig.builder)\r\n//                 .then(function (output) {\r\n//                     var stream = source(name);\r\n\r\n//                     stream.write(output.source);\r\n//                     process.nextTick(function () {\r\n//                         stream.end();\r\n//                     });\r\n\r\n//                     return stream.pipe(vinylBuffer())\r\n//                         // .pipe(sourcemaps.init())\r\n//                         // .pipe(babel(bundlesConfig.bundleOption))\r\n//                         // .pipe(ngAnnotate({\r\n//                         //     sourceMap: true,\r\n//                         //     gulpWarnings: false\r\n//                         // }))\r\n//                         .pipe(uglify())\r\n//                         // .pipe(rename({ suffix: '.min' }))\r\n//                         // .pipe(sourcemaps.write())\r\n//                         .pipe(gulp.dest(dest))\r\n//                         .on('end', resolve)\r\n//                         .on('error', reject);\r\n//                 }, reject);\r\n//         });\r\n//     }\r\n\r\n//     /**\r\n//      * Create bundles using the bundle configuration. If no bundles are\r\n//      * specified, all groups will be bundles.\r\n//      *\r\n//      * Example:\r\n//      * bundler.bundle(['app', 'routes']);\r\n//      *\r\n//      * @param {Array} groups\r\n//      * @returns {Promise}\r\n//      */\r\n//     bundle(groups?: string | string[]): Promise<any> {\r\n\r\n//         let option = this.config.option;\r\n\r\n//         if (_.isEmpty(option.bundles)) {\r\n//             throw new Error('Cant bundle until bundles are defined');\r\n//         }\r\n\r\n//         let bundlegs: string[] = [];\r\n\r\n//         if (groups) {\r\n//             if ((_.isArray(groups))) {\r\n//                 bundlegs = <string[]>groups;\r\n//             } else if (_.isString(groups)) {\r\n//                 bundlegs = groups.indexOf(',') > 0 ? (<string>groups).split(',') : [<string>groups];\r\n//             }\r\n//         }\r\n\r\n//         if (bundlegs.length < 1) {\r\n//             bundlegs = _.keys(option.bundles);\r\n//         }\r\n\r\n//         console.log(`bundles: ${bundlegs}`);\r\n\r\n//         let thenable: Promise<any> = Promise.resolve(this.config);\r\n\r\n//         let allBundles = [];\r\n//         _.each(bundlegs, name => {\r\n//             thenable = thenable.then(() => {\r\n//                 return this.groupBundle(name)\r\n//                     .then((bundles: any) => {\r\n//                         if (_.isArray(bundles)) {\r\n//                             allBundles = allBundles.concat(<any[]>bundles);\r\n//                         } else {\r\n//                             allBundles.push(bundles);\r\n//                         }\r\n//                         return allBundles;\r\n//                     });\r\n//             });\r\n//         });\r\n\r\n//         return thenable.then((bundles: any[]) => {\r\n//             if (option.bust) {\r\n//                 return this.calcChecksums(bundles).then((checksums) => {\r\n//                     return this.updateBundleManifest(bundles, checksums).then(function () {\r\n//                         console.log(chalk.green('------ Complete -------------'));\r\n//                     });\r\n//                 });\r\n//             } else {\r\n//                 return this.updateBundleManifest(bundles).then(function () {\r\n//                     console.log(chalk.green('------ Complete -------------'));\r\n//                 });\r\n//             }\r\n//         })\r\n//             .catch(err => {\r\n//                 console.error(chalk.red(err));\r\n//             });\r\n//     }\r\n\r\n\r\n//     unbundle(groups?: string | string[]): Promise<any> {\r\n\r\n//         console.log('------ Unbundling -----------');\r\n\r\n//         if (!groups) {\r\n//             console.warn(chalk.yellow('Removing all bundles...'));\r\n//             return this.writeBundleManifest(null);\r\n//         }\r\n\r\n//         let bundlegs: string[];\r\n\r\n//         if ((_.isArray(groups))) {\r\n//             bundlegs = <string[]>groups;\r\n//         } else if (_.isString(groups)) {\r\n//             bundlegs = groups.indexOf(',') > 0 ? (<string>groups).split(',') : [<string>groups];\r\n//         }\r\n\r\n\r\n//         var unbundles = [];\r\n//         var shortPath = '';\r\n\r\n//         _.forEach(bundlegs, function (groupName) {\r\n\r\n//             var bundleOpts = this.getBundleOpts(groupName);\r\n\r\n//             if (bundleOpts.combine) {\r\n\r\n//                 shortPath = this.getBundleShortPath(groupName, bundleOpts);\r\n//                 unbundles.push({ path: shortPath });\r\n//                 console.log('Success removed:', chalk.cyan(shortPath));\r\n\r\n//             } else {\r\n\r\n//                 _.forEach(bundleOpts.items, function (item) {\r\n//                     shortPath = this.getBundleShortPath(item, bundleOpts);\r\n//                     unbundles.push({ path: shortPath });\r\n//                     console.log('Success removed:', chalk.cyan(shortPath));\r\n//                 });\r\n\r\n//             }\r\n\r\n//         });\r\n\r\n//         return this.removeFromBundleManifest(unbundles);\r\n\r\n//     }\r\n\r\n//     protected groupBundle(name: string): Promise<any> {\r\n//         let option = this.config.option;\r\n\r\n//         let bundleOpts = this.getBundleOpts(name);\r\n//         if (!bundleOpts) {\r\n//             return Promise.reject(<any>('Unable to find group: ' + name));\r\n\r\n//         }\r\n\r\n\r\n\r\n//         let bundleStr = '';\r\n//         let bundleDest = '';\r\n\r\n//         let bundleItems: string[] = [];\r\n//         let minusStr = this.exclusionString(bundleOpts.exclude, option.bundles);\r\n\r\n//         if (bundleOpts.items) {\r\n//             bundleItems = _.isArray(bundleItems) ? <string[]>bundleOpts.items : _.keys(bundleOpts.items);\r\n//         }\r\n\r\n//         console.log(`-------------------------------\\nBundling group: ${chalk.cyan(name)} ... \\ngroup items:\\n  ${chalk.cyan(<any>bundleItems)}\\n-------------------------------`);\r\n\r\n\r\n//         let jsbuilder = new jspm.Builder({ separateCSS: bundleOpts.builder.separateCSS });\r\n\r\n//         return Promise.resolve(jsbuilder)\r\n//             .then(builder => {\r\n//                 if (option.jspmConfig) {\r\n//                     return builder.loadConfig(option.jspmConfig, undefined, true)\r\n//                         .then(() => {\r\n//                             return builder;\r\n//                         });\r\n//                 } else {\r\n//                     return builder;\r\n//                 }\r\n//             })\r\n//             .then(builder => {\r\n//                 builder.config(bundleOpts.builder.config);\r\n\r\n//                 if (bundleOpts.combine) {\r\n//                     bundleDest = this.getBundleDest(name, bundleOpts);\r\n//                     bundleStr = bundleItems.join(' + ') + minusStr;\r\n//                     return this.createBundler(builder, name, bundleStr, bundleDest, bundleOpts);\r\n\r\n//                 } else {\r\n//                     return Promise.all(bundleItems.map(key => {\r\n//                         bundleStr = key + minusStr;\r\n//                         bundleDest = this.getBundleDest(key, bundleOpts);\r\n//                         return this.createBundler(builder, key, bundleStr, bundleDest, bundleOpts);\r\n//                     }));\r\n//                 }\r\n\r\n//             });\r\n//     }\r\n\r\n//     private exclusionString(exclude, groups): string {\r\n//         var str = this.exclusionArray(exclude, groups).join(' - ');\r\n//         return (str) ? ' - ' + str : '';\r\n//     }\r\n\r\n//     private exclusionArray(exclude, groups): string[] {\r\n//         var minus: string[] = [];\r\n//         exclude = (_.isArray(exclude)) ? exclude : _.keys(exclude);\r\n//         _.forEach(exclude, (item: string) => {\r\n//             var group = groups[item];\r\n//             if (group) {\r\n//                 // exclude everything from this group\r\n//                 minus = minus.concat(this.exclusionArray(group.items, groups));\r\n//             } else {\r\n//                 // exclude this item by name\r\n//                 minus.push(item);\r\n//             }\r\n//         });\r\n//         return minus;\r\n//     }\r\n\r\n//     private createBundler(builder: any, bundleName: string, bundleStr: string, bundleDest: string, bundleOpts: IBundleGroup): Promise<any> {\r\n\r\n//         let sfx = bundleOpts.builder.sfx;\r\n//         let bundler = (sfx) ? builder.buildStatic : builder.bundle;\r\n//         let shortPath = this.getBundleShortPath(bundleName, bundleOpts);\r\n//         let filename = path.parse(bundleDest).base;\r\n\r\n//         let buildConfig;\r\n//         if (bundleOpts.toES5) {\r\n//             buildConfig = _.clone(bundleOpts.builder);\r\n//             buildConfig.minify = false;\r\n//             buildConfig.sourceMaps = false;\r\n//         } else {\r\n//             buildConfig = bundleOpts.builder;\r\n//         }\r\n\r\n//         return bundler.bind(builder)(bundleStr, bundleDest, buildConfig)\r\n//             .then(output => {\r\n\r\n//                 mkdirp.sync(path.dirname(bundleDest));\r\n\r\n//                 if (bundleOpts.toES5) {\r\n//                     return new Promise<any>((resolve, reject) => {\r\n//                         var stream = source(filename);\r\n\r\n//                         stream.write(output.source);\r\n//                         process.nextTick(function () {\r\n//                             stream.end();\r\n//                         });\r\n\r\n//                         return stream.pipe(vinylBuffer())\r\n//                             // .pipe(sourcemaps.init())\r\n//                             // .pipe(ngAnnotate())\r\n//                             .pipe(uglify())\r\n//                             // .pipe(rename({ suffix: '.min' }))\r\n//                             // .pipe(sourcemaps.write('.'))\r\n//                             .pipe(gulp.dest(path.dirname(bundleDest)))\r\n//                             .on('end', () => {\r\n//                                 resolve(output);\r\n//                             })\r\n//                             .on('error', reject);\r\n//                     });\r\n\r\n//                 } else {\r\n\r\n//                     writeFileSync(bundleDest, output.source);\r\n//                     return output;\r\n//                 }\r\n//             })\r\n//             .then(output => {\r\n//                 if (sfx) {\r\n//                     console.log(`Built sfx package: ${chalk.cyan(bundleName)} -> ${chalk.cyan(filename)}\\n   dest: ${chalk.cyan(bundleDest)}`);\r\n//                 } else {\r\n//                     console.log(`Bundled package: ${chalk.cyan(bundleName)} -> ${chalk.cyan(filename)}\\n   dest: ${chalk.cyan(bundleDest)}`);\r\n//                 }\r\n//                 return {\r\n//                     path: shortPath,\r\n//                     modules: output.modules\r\n//                 };\r\n//             });\r\n\r\n\r\n//     }\r\n\r\n\r\n\r\n//     private calcChecksums(bundles: any[]): Promise<any> {\r\n//         let chksums = {};\r\n\r\n//         console.log('Calculating checksums...');\r\n\r\n//         return Promise.all(_.map(bundles, (bundle: any) => {\r\n//             if (!_.isObject(bundle)) {\r\n//                 return null;\r\n//             }\r\n\r\n//             return new Promise((resolve, reject) => {\r\n//                 let filepath = path.join(this.config.option.baseURL, bundle.path);\r\n//                 let filename = path.parse(bundle.path).base;\r\n//                 chksum.file(filepath, (err, sum) => {\r\n//                     if (err) {\r\n//                         console.error(chalk.red(' Checksum Error:'), chalk.red(err));\r\n//                     }\r\n//                     console.log(filename, chalk.cyan(sum));\r\n//                     chksums[bundle.path] = sum;\r\n//                     resolve(chksums);\r\n//                 });\r\n//             });\r\n\r\n//         })).then(() => {\r\n//             return chksums;\r\n//         });\r\n//     }\r\n\r\n//     protected updateBundleManifest(bundles: any[], chksums?: any) {\r\n\r\n//         chksums = chksums || {};\r\n\r\n//         var manifest: any = _.defaults(this.getBundleManifest(), {\r\n//             bundles: {},\r\n//             chksums: {}\r\n//         });\r\n\r\n//         // console.log(manifest);\r\n\r\n//         _.each(bundles, bundle => {\r\n//             if (bundle.path) {\r\n//                 manifest.bundles[bundle.path] = bundle.modules;\r\n//                 manifest.chksums[bundle.path] = chksums[bundle.path] || '';\r\n//             }\r\n//         });\r\n\r\n//         return this.writeBundleManifest(manifest);\r\n\r\n//     }\r\n\r\n//     protected removeFromBundleManifest(bundles): Promise<any> {\r\n\r\n//         var manifest: any = _.defaults(this.getBundleManifest(), {\r\n//             bundles: {},\r\n//             chksums: {}\r\n//         });\r\n\r\n//         _.forEach(bundles, function (bundle) {\r\n//             delete manifest.bundles[bundle.path];\r\n//             delete manifest.chksums[bundle.path];\r\n//         });\r\n\r\n//         return this.writeBundleManifest(manifest);\r\n\r\n//     }\r\n\r\n//     private manifestSplit = `/*------bundles infos------*/`;\r\n//     private writeBundleManifest(manifest): Promise<any> {\r\n\r\n//         let option = this.config.option;\r\n\r\n//         if (!option.file) {\r\n//             return Promise.resolve(true);\r\n//         }\r\n\r\n\r\n//         console.log('Writing manifest...');\r\n\r\n//         let options = option;\r\n\r\n//         let output = `System.config({\r\n//             baseURL: '${options.rootUri || '.'}',\r\n//             defaultJSExtensions: true\r\n//         });\r\n//         System.bundled = true;\r\n//         System.bust = '${options.bust}';\r\n//         if(window != undefined) window.prod = true;\r\n//         ${this.manifestSplit}\r\n//         `;\r\n//         let template = '';\r\n\r\n//         if (manifest) {\r\n//             // try {\r\n//             template = option.systemConfigTempl;\r\n\r\n//             if (!template) {\r\n//                 template = (option.bust) ?\r\n//                     `\r\n//                     (function(module) {\r\n//                     var bust = {};\r\n//                     var systemLocate = System.locate;\r\n//                     var systemNormalize = System.normalize;\r\n\r\n//                     var chksums = module.exports.chksums = \\${chksums};\r\n//                     var bundles = module.exports.bundles = \\${bundles};                    \r\n//                     var maps = \\${ maps };\r\n//                     var jspmMeta = \\${ jspmMeta };\r\n\r\n//                     System.config({\r\n//                          packages: {\r\n//                             \"meta\": jspmMeta\r\n//                         },\r\n//                         map: maps,\r\n//                         //paths: paths,\r\n//                         bundles: bundles\r\n//                     });\r\n\r\n//                     System.normalize = function (name, pName, pAddress) {\r\n//                         return systemNormalize.call(this, name, pName, pAddress).then(function (address) {\r\n//                             var chksum = chksums[name];\r\n//                             if (chksums[name]) { bust[address] = chksum; }\r\n//                             return address;\r\n//                         });\r\n//                     };\r\n\r\n//                     System.locate = function (load) {\r\n//                         return Promise.resolve(systemLocate.call(this, load)).then(function (address) {\r\n//                             var chksum = bust[address];\r\n//                             return (chksum) ? address + '?' + chksum : address;\r\n//                         });\r\n//                     };\r\n\r\n//                 })((typeof module !== 'undefined') ? module : {exports: {}}, this);\r\n//                 `\r\n//                     :\r\n//                     `\r\n//                     (function(module) {\r\n//                     var bundles = module.exports.bundles = \\${bundles};\r\n//                     var paths =  module.exports.paths = \\${paths};\r\n//                     var maps = \\${ maps };\r\n//                     var jspmMeta = \\${ jspmMeta };\r\n\r\n//                     System.config({\r\n//                          packages: {\r\n//                             \"meta\": jspmMeta\r\n//                         },\r\n//                         map: maps,\r\n//                         //paths: paths,\r\n//                         bundles: bundles\r\n//                     });\r\n\r\n//                 })((typeof module !== 'undefined') ? module : {exports: {}}, this);\r\n//                 `;\r\n//             }\r\n\r\n//             // } catch (e) {\r\n\r\n//             //     console.log(' X Unable to open manifest template');\r\n//             //     console.log(e);\r\n//             //     return Promise.reject(<any>false);\r\n\r\n//             // }\r\n\r\n\r\n//             let maps = {\r\n//                 css: 'github:systemjs/plugin-css@0.1.20.js',\r\n//                 json: 'github:systemjs/plugin-json@0.1.2.js'\r\n//             };\r\n\r\n//             _.each(_.keys(manifest.bundles), n => {\r\n//                 if (/css.min.js$/.test(n)) {\r\n//                     maps.css = <string>_.first(manifest.bundles[n]);\r\n//                 }\r\n//                 if (/json.min.js$/.test(n)) {\r\n//                     maps.css = <string>_.first(manifest.bundles[n]);\r\n//                 }\r\n//             });\r\n\r\n//             let jspmMetas = option.jspmMetas;\r\n//             output += _.template(template)({\r\n//                 maps: JSON.stringify(maps, null, '    '),\r\n//                 jspmMeta: JSON.stringify(jspmMetas, null, '    '),\r\n//                 // paths: JSON.stringify(this.options.builder.config.paths, null, '    '),\r\n//                 chksums: JSON.stringify(manifest.chksums, null, '    '),\r\n//                 bundles: JSON.stringify(manifest.bundles, null, '    '),\r\n//             });\r\n\r\n//         }\r\n\r\n//         let mainfile = this.getBundleManifestPath();\r\n//         if (!existsSync(mainfile)) {\r\n//             mkdirp.sync(path.dirname(mainfile));\r\n\r\n//             writeFileSync(mainfile, output, { flag: 'wx' });\r\n//         } else {\r\n//             writeFileSync(mainfile, output);\r\n//         }\r\n\r\n//         console.log(chalk.green('Manifest written'));\r\n\r\n//         return Promise.resolve(true);\r\n\r\n//     }\r\n\r\n//     private getBundleManifestPath(): string {\r\n//         var url = this.config.option.baseURL;\r\n//         return path.join(url, this.config.option.file);\r\n//     }\r\n//     private getBundleManifest(): any {\r\n//         let data: any = {};\r\n//         let path: string = this.getBundleManifestPath();\r\n//         if (existsSync(path)) {\r\n//             try {\r\n//                 let content = readFileSync(path, 'utf8');\r\n//                 let idx = content.indexOf(this.manifestSplit);\r\n//                 idx = idx > 0 ? (idx + this.manifestSplit.length) : 0;\r\n//                 content = content.substring(idx);\r\n//                 // console.log(content);\r\n//                 writeFileSync(path, content);\r\n//                 data = require(path);\r\n//                 console.log('has old bundle：\\n', chalk.cyan(path)); // , 'data:\\n', data);\r\n//             } catch (e) {\r\n//                 console.log(chalk.red(e));\r\n//             }\r\n//         }\r\n\r\n//         return data;\r\n//     }\r\n\r\n//     private getBundleOpts(name: string): IBundleGroup {\r\n//         let bundleOpts = this.config.option.bundles[name];\r\n//         if (bundleOpts) {\r\n//             bundleOpts.builder = <IBuidlerConfig>_.defaults(bundleOpts.builder, this.config.option.builder);\r\n//             return bundleOpts;\r\n//         } else {\r\n//             return null;\r\n//         }\r\n//     }\r\n\r\n//     private getBundleShortPath(bundleName: string, bundleOpts: IBundleGroup) {\r\n//         var fullPath = this.getBundleDest(bundleName, bundleOpts);\r\n//         let spath: string = path.relative(this.config.option.baseURL, fullPath);\r\n//         spath = spath.replace(/\\\\/g, '/').replace(/^\\//g, '');\r\n//         return spath;\r\n//     }\r\n\r\n//     private getBundleDest(bundleName: string, bundleOpts: IBundleGroup) {\r\n\r\n//         var url = path.join(this.config.option.baseURL, this.config.getDist());\r\n//         var min = bundleOpts.builder.minify;\r\n//         var name = bundleOpts.items[bundleName] || bundleName;\r\n//         var file = name + ((min) ? '.min.js' : '.js');\r\n\r\n//         if (bundleOpts.combine) {\r\n//             url = path.join(url, bundleName, file);\r\n//         } else {\r\n//             url = path.join(url, file);\r\n//         }\r\n\r\n//         return url;\r\n//     }\r\n// }\r\n"]}
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var s=0;s<n.length;s++){var t=n[s];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,s,t){return s&&e(n.prototype,s),t&&e(n,t),n}}(),_=require("lodash"),path=require("path"),gulp=require("gulp"),fs_1=require("fs"),chalk=require("chalk"),jspm=require("jspm"),source=require("vinyl-source-stream"),vinylBuffer=require("vinyl-buffer"),uglify=require("gulp-uglify"),chksum=require("checksum"),mkdirp=require("mkdirp"),JspmBuilder=function(){function e(n){_classCallCheck(this,e),this.options=n,this.manifestSplit="/*------bundles infos------*/",this.options=_.extend({dest:"",file:"",systemConfigTempl:"",relationToRoot:"",bust:"",bundles:{},jspmMates:{"*.css":{loader:"css"},"*.json":{loader:"json"},"*.jsx":{loader:"jsx"}},builder:{sfx:!1,minify:!1,mangle:!1,sourceMaps:!1,separateCSS:!1,lowResSourceMaps:!0}},this.options);var s=path.dirname(module.parent.filename)+"/";this.options.root=this.options.root||s,path.isAbsolute(this.options.baseURL)||(this.options.baseURL=path.join(this.options.root,this.options.baseURL,"/")||s),console.log("bundles config:",chalk.cyan(this.options))}return _createClass(e,[{key:"bundleAll",value:function(e,n,s,t){t=t||this.options;var i=new jspm.Builder({separateCSS:t.builder.separateCSS});i.config(t.builder.config);var r=t.builder.sfx,o=r?i.buildStatic:i.bundle;return new Promise(function(r,u){o.bind(i)(n,t.builder).then(function(n){var t=source(e);return t.write(n.source),process.nextTick(function(){t.end()}),t.pipe(vinylBuffer()).pipe(uglify()).pipe(gulp.dest(s)).on("end",r).on("error",u)},u)})}},{key:"bundle",value:function(e){var n=this;if(_.isEmpty(this.options.bundles))throw new Error("Cant bundle until bundles are defined");var s=[];e&&(_.isArray(e)?s=e:_.isString(e)&&(s=e.indexOf(",")>0?e.split(","):[e])),s.length<1&&(s=_.keys(this.options.bundles)),console.log("bundles: "+s);var t=Promise.resolve(this.options),i=[];return _.each(s,function(e){t=t.then(function(){return n.groupBundle(e).then(function(e){return _.isArray(e)?i=i.concat(e):i.push(e),i})})}),t.then(function(e){return n.options.bust?n.calcChecksums(e).then(function(s){return n.updateBundleManifest(e,s).then(function(){console.log(chalk.green("------ Complete -------------"))})}):n.updateBundleManifest(e).then(function(){console.log(chalk.green("------ Complete -------------"))})}).catch(function(e){console.error(chalk.red(e))})}},{key:"unbundle",value:function(e){if(console.log("------ Unbundling -----------"),!e)return console.warn(chalk.yellow("Removing all bundles...")),this.writeBundleManifest(null);var n=void 0;_.isArray(e)?n=e:_.isString(e)&&(n=e.indexOf(",")>0?e.split(","):[e]);var s=[],t="";return _.forEach(n,function(e){var n=this.getBundleOpts(e);n.combine?(t=this.getBundleShortPath(e,n),s.push({path:t}),console.log("Success removed:",chalk.cyan(t))):_.forEach(n.items,function(e){t=this.getBundleShortPath(e,n),s.push({path:t}),console.log("Success removed:",chalk.cyan(t))})}),this.removeFromBundleManifest(s)}},{key:"groupBundle",value:function(e){var n=this,s=this.getBundleOpts(e);if(!s)return Promise.reject("Unable to find group: "+e);var t="",i="",r=[],o=this.exclusionString(s.exclude,this.options.bundles);s.items&&(r=_.isArray(r)?s.items:_.keys(s.items)),console.log("-------------------------------\nBundling group: "+chalk.cyan(e)+" ... \ngroup items:\n  "+chalk.cyan(r)+"\n-------------------------------");var u=new jspm.Builder({separateCSS:s.builder.separateCSS});return Promise.resolve(u).then(function(e){return n.options.jspmConfig?e.loadConfig(n.options.jspmConfig,void 0,!0).then(function(){return e}):e}).then(function(u){return u.config(s.builder.config),s.combine?(i=n.getBundleDest(e,s),t=r.join(" + ")+o,n.createBundler(u,e,t,i,s)):Promise.all(r.map(function(e){return t=e+o,i=n.getBundleDest(e,s),n.createBundler(u,e,t,i,s)}))})}},{key:"exclusionString",value:function(e,n){var s=this.exclusionArray(e,n).join(" - ");return s?" - "+s:""}},{key:"exclusionArray",value:function(e,n){var s=this,t=[];return e=_.isArray(e)?e:_.keys(e),_.forEach(e,function(e){var i=n[e];i?t=t.concat(s.exclusionArray(i.items,n)):t.push(e)}),t}},{key:"createBundler",value:function(e,n,s,t,i){var r=i.builder.sfx,o=r?e.buildStatic:e.bundle,u=this.getBundleShortPath(n,i),a=path.parse(t).base,l=void 0;return i.toES5?(l=_.clone(i.builder),l.minify=!1,l.sourceMaps=!1):l=i.builder,o.bind(e)(s,t,l).then(function(e){return mkdirp.sync(path.dirname(t)),i.toES5?new Promise(function(n,s){var i=source(a);return i.write(e.source),process.nextTick(function(){i.end()}),i.pipe(vinylBuffer()).pipe(uglify()).pipe(gulp.dest(path.dirname(t))).on("end",function(){n(e)}).on("error",s)}):(fs_1.writeFileSync(t,e.source),e)}).then(function(e){return r?console.log("Built sfx package: "+chalk.cyan(n)+" -> "+chalk.cyan(a)+"\n   dest: "+chalk.cyan(t)):console.log("Bundled package: "+chalk.cyan(n)+" -> "+chalk.cyan(a)+"\n   dest: "+chalk.cyan(t)),{path:u,modules:e.modules}})}},{key:"calcChecksums",value:function(e){var n=this,s={};return console.log("Calculating checksums..."),Promise.all(_.map(e,function(e){return _.isObject(e)?new Promise(function(t,i){var r=path.join(n.options.baseURL,e.path),o=path.parse(e.path).base;chksum.file(r,function(n,i){n&&console.error(chalk.red(" Checksum Error:"),chalk.red(n)),console.log(o,chalk.cyan(i)),s[e.path]=i,t(s)})}):null})).then(function(){return s})}},{key:"updateBundleManifest",value:function(e,n){n=n||{};var s=_.defaults(this.getBundleManifest(),{bundles:{},chksums:{}});return _.each(e,function(e){e.path&&(s.bundles[e.path]=e.modules,s.chksums[e.path]=n[e.path]||"")}),this.writeBundleManifest(s)}},{key:"removeFromBundleManifest",value:function(e){var n=_.defaults(this.getBundleManifest(),{bundles:{},chksums:{}});return _.forEach(e,function(e){delete n.bundles[e.path],delete n.chksums[e.path]}),this.writeBundleManifest(n)}},{key:"writeBundleManifest",value:function(e){var n=this;if(!this.options.file)return Promise.resolve(!0);console.log("Writing manifest...");var s=this.options,t="System.config({\n            baseURL: '"+(s.baseUri||".")+"',\n            defaultJSExtensions: true\n        });\n        System.bundled = true;\n        System.bust = '"+s.bust+"';\n        if(window != undefined) window.prod = true;\n        "+this.manifestSplit+"\n        ",i="";e&&!function(){i=n.options.systemConfigTempl,i||(i=n.options.bust?"\n                    (function(module) {\n                    var bust = {};\n                    var systemLocate = System.locate;\n                    var systemNormalize = System.normalize;\n\n                    var chksums = module.exports.chksums = ${chksums};\n                    var bundles = module.exports.bundles = ${bundles};                    \n                    var maps = ${ maps };\n                    var jspmMeta = ${ jspmMeta };\n\n                    System.config({\n                         packages: {\n                            \"meta\": jspmMeta\n                        },\n                        map: maps,\n                        //paths: paths,\n                        bundles: bundles\n                    });\n\n                    System.normalize = function (name, pName, pAddress) {\n                        return systemNormalize.call(this, name, pName, pAddress).then(function (address) {\n                            var chksum = chksums[name];\n                            if (chksums[name]) { bust[address] = chksum; }\n                            return address;\n                        });\n                    };\n\n                    System.locate = function (load) {\n                        return Promise.resolve(systemLocate.call(this, load)).then(function (address) {\n                            var chksum = bust[address];\n                            return (chksum) ? address + '?' + chksum : address;\n                        });\n                    };\n\n                })((typeof module !== 'undefined') ? module : {exports: {}}, this);\n                ":"\n                    (function(module) {\n                    var bundles = module.exports.bundles = ${bundles};\n                    var paths =  module.exports.paths = ${paths};\n                    var maps = ${ maps };\n                    var jspmMeta = ${ jspmMeta };\n\n                    System.config({\n                         packages: {\n                            \"meta\": jspmMeta\n                        },\n                        map: maps,\n                        //paths: paths,\n                        bundles: bundles\n                    });\n\n                })((typeof module !== 'undefined') ? module : {exports: {}}, this);\n                ");var s={css:"github:systemjs/plugin-css@0.1.20.js",json:"github:systemjs/plugin-json@0.1.2.js"};_.each(_.keys(e.bundles),function(n){/css.min.js$/.test(n)&&(s.css=_.first(e.bundles[n])),/json.min.js$/.test(n)&&(s.css=_.first(e.bundles[n]))});var r=n.options.jspmMetas;t+=_.template(i)({maps:JSON.stringify(s,null,"    "),jspmMeta:JSON.stringify(r,null,"    "),chksums:JSON.stringify(e.chksums,null,"    "),bundles:JSON.stringify(e.bundles,null,"    ")})}();var r=this.getBundleManifestPath();return fs_1.existsSync(r)?fs_1.writeFileSync(r,t):(mkdirp.sync(path.dirname(r)),fs_1.writeFileSync(r,t,{flag:"wx"})),console.log(chalk.green("Manifest written")),Promise.resolve(!0)}},{key:"getBundleManifestPath",value:function(){var e=this.options.baseURL;return String(path.join(e,this.options.file))}},{key:"getBundleManifest",value:function(){var e={},n=this.getBundleManifestPath();if(fs_1.existsSync(n))try{var s=fs_1.readFileSync(n,"utf8"),t=s.indexOf(this.manifestSplit);t=t>0?t+this.manifestSplit.length:0,s=s.substring(t),fs_1.writeFileSync(n,s),e=require(n),console.log("has old bundleï¼š\n",chalk.cyan(n))}catch(e){console.log(chalk.red(e))}return e}},{key:"getBundleOpts",value:function(e){var n=this.options.bundles[e];return n?(n.builder=_.defaults(n.builder,this.options.builder),n):null}},{key:"getBundleShortPath",value:function(e,n){var s=this.getBundleDest(e,n),t=path.relative(this.options.baseURL,s);return t=t.replace(/\\/g,"/").replace(/^\//g,"")}},{key:"getBundleDest",value:function(e,n){var s=path.join(this.options.baseURL,this.options.dest),t=n.builder.minify,i=n.items[e]||e,r=i+(t?".min.js":".js");return s=n.combine?path.join(s,e,r):path.join(s,r)}}]),e}();exports.JspmBuilder=JspmBuilder;
//# sourceMappingURL=sourcemaps/JspmBuilder.js.map

"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),_get=function e(n,t,r){null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,t);if(void 0===s){var u=Object.getPrototypeOf(n);return null===u?void 0:e(u,t,r)}if("value"in s)return s.value;var o=s.get;if(void 0!==o)return o.call(r)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},__decorate=function(e,n,t,r){var s,u=arguments.length,o=u<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,t):r;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,n,t,r);else for(var i=e.length-1;i>=0;i--)(s=e[i])&&(o=(u<3?s(o):u>3?s(n,t,o):s(n,t))||o);return u>3&&o&&Object.defineProperty(n,t,o),o},__metadata=function(e,n){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)},_=require("lodash"),development_core_1=require("development-core"),path=require("path"),fs_1=require("fs"),chalk=require("chalk"),jspm=require("jspm"),source=require("vinyl-source-stream"),vinylBuffer=require("vinyl-buffer"),chksum=require("checksum"),mkdirp=require("mkdirp"),JspmBundle=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.name="jspm-bundle",t.runWay=development_core_1.RunWay.sequence,t.manifestSplit="/*------bundles infos------*/",t}return _inherits(n,e),_createClass(n,[{key:"getOption",value:function(e){return e.option}},{key:"loadBuilder",value:function(e){var n=e.option,t=new jspm.Builder({separateCSS:n.builder.separateCSS});return Promise.resolve(t).then(function(e){return n.jspmConfig?e.loadConfig(n.jspmConfig,void 0,!0).then(function(){return e}):e})}},{key:"sourceStream",value:function(e,n,t){var r=this,s=e.option;return s.bundles?Promise.all(_.map(this.getbundles(e),function(n){return r.loadBuilder(e).then(function(u){var o=s.bundles[n];return o.builder=_.defaults(o.builder,s.builder),r.groupBundle(e,n,o,t)})})).then(function(e){return _.flatten(e)}):this.loadBuilder(e).then(function(n){n.config(s.builder.config);var t=s.builder.sfx,r=t?n.buildStatic:n.bundle;return r.bind(n)(e.getSrc(),s.builder)})}},{key:"execute",value:function(e,t){var r=this;return this.bundles=[],_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"execute",this).call(this,e,t).then(function(){var n=e.option;return n.bundles?n.bust?r.calcChecksums(n,r.bundles).then(function(e){return r.updateBundleManifest(n,r.bundles,e).then(function(){console.log(chalk.green("------ Complete -------------"))})}):r.updateBundleManifest(n,r.bundles).then(function(){console.log(chalk.green("------ Complete -------------"))}):(console.log(chalk.green("------ Complete -------------")),null)})}},{key:"working",value:function(e,t,r,s){var u=this,o=e.bundle;return o.sfx?console.log("Built sfx package: "+chalk.cyan(o.bundleName)+" -> "+chalk.cyan(o.filename)+"\n   dest: "+chalk.cyan(o.bundleDest)):console.log("Bundled package: "+chalk.cyan(o.bundleName)+" -> "+chalk.cyan(o.filename)+"\n   dest: "+chalk.cyan(o.bundleDest)),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"working",this).call(this,e,t,r,s).then(function(){var e={path:o.shortPath,modules:o.modules};return u.bundles.push(e),e})}},{key:"getbundles",value:function(e){var n=e.option,t=_.uniq(_.isArray(e.env.gb)?e.env.gb:(e.env.gb||"").split(","));return t=t.length<1?_.keys(n.bundles):_.filter(t,function(e){return e&&t[e]})}},{key:"groupBundle",value:function(e,n,t,r){var s=this,u=e.option,o="",i="",a=[],l=this.exclusionString(t.exclude,u.bundles);t.items&&(a=_.isArray(a)?t.items:_.keys(t.items)),console.log("-------------------------------\nBundling group: "+chalk.cyan(n)+" ... \ngroup items:\n  "+chalk.cyan(a)+"\n-------------------------------");var c=new jspm.Builder({separateCSS:t.builder.separateCSS});return Promise.resolve(c).then(function(e){return u.jspmConfig?e.loadConfig(u.jspmConfig,void 0,!0).then(function(){return e}):e}).then(function(u){return u.config(t.builder.config),t.combine?(i=s.getBundleDest(e,n,t),o=a.join(" + ")+l,s.createBundler(e,u,n,o,i,t,r)):Promise.all(a.map(function(n){return o=n+l,i=s.getBundleDest(e,n,t),s.createBundler(e,u,n,o,i,t,r)}))})}},{key:"exclusionString",value:function(e,n){var t=this.exclusionArray(e,n).join(" - ");return t?" - "+t:""}},{key:"exclusionArray",value:function(e,n){var t=this,r=[];return e=_.isArray(e)?e:_.keys(e),_.forEach(e,function(e){var s=n[e];s?r=r.concat(t.exclusionArray(s.items,n)):r.push(e)}),r}},{key:"createBundler",value:function(e,n,t,r,s,u,o){var i=u.builder.sfx,a=i?n.buildStatic:n.bundle,l=this.getBundleShortPath(e,t,u),c=path.parse(s).base,d=void 0;return u.toES5?(d=_.clone(u.builder),d.minify=!1,d.sourceMaps=!1):d=u.builder,a.bind(n)(r,s,d).then(function(e){mkdirp.sync(path.dirname(s));var n=source(c);return n.write(e.source),process.nextTick(function(){n.end()}),n.pipe(vinylBuffer())}).then(function(e){return e.bundle={path:l,bundleName:t,filename:c,bundleDest:s,modules:e.modules},e})}},{key:"calcChecksums",value:function(e,n){var t={};return console.log("Calculating checksums..."),Promise.all(_.map(n,function(n){return _.isObject(n)?new Promise(function(r,s){var u=path.join(e.baseURL,n.path),o=path.parse(n.path).base;chksum.file(u,function(e,s){e&&console.error(chalk.red(" Checksum Error:"),chalk.red(e)),console.log(o,chalk.cyan(s)),t[n.path]=s,r(t)})}):null})).then(function(){return t})}},{key:"updateBundleManifest",value:function(e,n,t){t=t||{};var r=_.defaults(this.getBundleManifest(e),{bundles:{},chksums:{}});return _.each(n,function(e){e.path&&(r.bundles[e.path]=e.modules,r.chksums[e.path]=t[e.path]||"")}),this.writeBundleManifest(e,r)}},{key:"removeFromBundleManifest",value:function(e,n){var t=_.defaults(this.getBundleManifest(e),{bundles:{},chksums:{}});return _.forEach(n,function(e){delete t.bundles[e.path],delete t.chksums[e.path]}),this.writeBundleManifest(e,t)}},{key:"writeBundleManifest",value:function(e,n){if(!e.file)return Promise.resolve(!0);console.log("Writing manifest...");var t=e,r="System.config({\n            baseURL: '"+(t.rootUri||".")+"',\n            defaultJSExtensions: true\n        });\n        System.bundled = true;\n        System.bust = '"+t.bust+"';\n        if(window != undefined) window.prod = true;\n        "+this.manifestSplit+"\n        ",s="";n&&!function(){s=e.systemConfigTempl,s||(s=e.bust?"\n                    (function(module) {\n                    var bust = {};\n                    var systemLocate = System.locate;\n                    var systemNormalize = System.normalize;\n\n                    var chksums = module.exports.chksums = ${chksums};\n                    var bundles = module.exports.bundles = ${bundles};                    \n                    var maps = ${ maps };\n                    var jspmMeta = ${ jspmMeta };\n\n                    System.config({\n                         packages: {\n                            \"meta\": jspmMeta\n                        },\n                        map: maps,\n                        //paths: paths,\n                        bundles: bundles\n                    });\n\n                    System.normalize = function (name, pName, pAddress) {\n                        return systemNormalize.call(this, name, pName, pAddress).then(function (address) {\n                            var chksum = chksums[name];\n                            if (chksums[name]) { bust[address] = chksum; }\n                            return address;\n                        });\n                    };\n\n                    System.locate = function (load) {\n                        return Promise.resolve(systemLocate.call(this, load)).then(function (address) {\n                            var chksum = bust[address];\n                            return (chksum) ? address + '?' + chksum : address;\n                        });\n                    };\n\n                })((typeof module !== 'undefined') ? module : {exports: {}}, this);\n                ":"\n                    (function(module) {\n                    var bundles = module.exports.bundles = ${bundles};\n                    var paths =  module.exports.paths = ${paths};\n                    var maps = ${ maps };\n                    var jspmMeta = ${ jspmMeta };\n\n                    System.config({\n                         packages: {\n                            \"meta\": jspmMeta\n                        },\n                        map: maps,\n                        //paths: paths,\n                        bundles: bundles\n                    });\n\n                })((typeof module !== 'undefined') ? module : {exports: {}}, this);\n                ");var t={css:"github:systemjs/plugin-css@0.1.20.js",json:"github:systemjs/plugin-json@0.1.2.js"};_.each(_.keys(n.bundles),function(e){/css.min.js$/.test(e)&&(t.css=_.first(n.bundles[e])),/json.min.js$/.test(e)&&(t.css=_.first(n.bundles[e]))});var u=e.jspmMetas;r+=_.template(s)({maps:JSON.stringify(t,null,"    "),jspmMeta:JSON.stringify(u,null,"    "),chksums:JSON.stringify(n.chksums,null,"    "),bundles:JSON.stringify(n.bundles,null,"    ")})}();var u=this.getBundleManifestPath(e);return fs_1.existsSync(u)?fs_1.writeFileSync(u,r):(mkdirp.sync(path.dirname(u)),fs_1.writeFileSync(u,r,{flag:"wx"})),console.log(chalk.green("Manifest written")),Promise.resolve(!0)}},{key:"getBundleManifestPath",value:function(e){var n=e.baseURL;return path.join(n,e.file)}},{key:"getBundleManifest",value:function(e){var n={},t=this.getBundleManifestPath(e);if(fs_1.existsSync(t))try{var r=fs_1.readFileSync(t,"utf8"),s=r.indexOf(this.manifestSplit);s=s>0?s+this.manifestSplit.length:0,r=r.substring(s),fs_1.writeFileSync(t,r),n=require(t),console.log("has old bundle：\n",chalk.cyan(t))}catch(e){console.log(chalk.red(e))}return n}},{key:"getBundleShortPath",value:function(e,n,t){var r=this.getBundleDest(e,n,t),s=path.relative(e.option.baseURL,r);return s=s.replace(/\\/g,"/").replace(/^\//g,"")}},{key:"getBundleDest",value:function(e,n,t){var r=path.join(e.option.baseURL,e.getDist()),s=t.builder.minify,u=t.items[n]||n,o=u+(s?".min.js":".js");return r=t.combine?path.join(r,n,o):path.join(r,o)}}]),n}(development_core_1.PipeTask);JspmBundle=__decorate([development_core_1.task({oper:development_core_1.Operation.release|development_core_1.Operation.deploy}),__metadata("design:paramtypes",[Object])],JspmBundle),exports.JspmBundle=JspmBundle;
//# sourceMappingURL=sourcemaps/task.js.map
